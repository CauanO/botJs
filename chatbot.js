const qrcode = require('qrcode-terminal');
const { Client, Buttons, List, MessageMedia, LocalAuth } = require('whatsapp-web.js');
const path = require('path');

const client = new Client({
    authStrategy: new LocalAuth({ clientId: 'ij-delivery-bot' }),
    puppeteer: {
        executablePath: 'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    }
});

client.on('qr', qr => {
    console.clear();
    qrcode.generate(qr, { small: true });
    console.log('\nEscaneie o QR code acima para autenticar no WhatsApp.');
});

client.on('ready', () => {
    console.log('‚úÖ Bot conectado ao WhatsApp com sucesso!');
});

client.on('auth_failure', msg => {
    console.error('‚ùå Falha na autentica√ß√£o', msg);
});

client.on('disconnected', reason => {
    console.warn('‚ö†Ô∏è Cliente desconectado!', reason);
});

client.initialize();

const delay = ms => new Promise(res => setTimeout(res, ms));
let aguardandoSenha = {};

const GATILHO_SAUDACAO = /^(oi|ol√°|ola|bom dia|boa tarde|boa noite)$/i;
const precosFrete = {
    "bom ser√°": 3,
    "licurizal": 3,
    "buraco d‚Äô√°gua": 3,
    "lagoa velha": 5,
    "gazai": 5,
    "baixa da ema": 5,
    "batista": 7,
    "ipoeira": 7,
    "pedra azul": 7,
    "pindura saia": 10,
    "roma": 10,
    "araticum": 12,
    "quatro estradas": 15,
    "ponto": 15,
    "cabe√ßa do boi": 15
};
const VALOR_ACAI = 10.00;
const TAXA_DEBITO = 1.43;
const TAXA_CREDITO = 3.38;
client.on('message', async msg => {
    const chat = await msg.getChat();

    if (msg.body.match(GATILHO_SAUDACAO)) {
        await chat.sendStateTyping();
        await client.sendMessage(msg.from,
            'Ol√° üòÑ Tudo bem?\Que bom te ver por aqui! Sou o rob√¥ assistente da IJ Delivery ,e irei agilizar seu pedido.'
        );
        await delay(1500);
        await chat.sendStateTyping();
        await client.sendMessage(msg.from, 'Para continuarmos, *me informa s√≥ seu nome* por favor?');
        aguardandoSenha[msg.from] = 'esperandoNome';
        return;
    }

    if (aguardandoSenha[msg.from] === 'esperandoNome') {
        const nome = msg.body.trim();
        await chat.sendStateTyping();
        await client.sendMessage(msg.from, `Perfeito, ${nome}! üëè`);
        await delay(1500);

        const imagePath = path.join(__dirname, 'img', 'cardapio.jpg');
        const cardapio = MessageMedia.fromFilePath(imagePath);

        await chat.sendStateTyping();
        await client.sendMessage(msg.from, cardapio, {
            // caption: 'üìã *Card√°pio Atualizado!*\nEscolha sua pizza ou a√ßa√≠ preferido üòã'
        });

        await delay(1500);
        await chat.sendStateTyping();
        await client.sendMessage(msg.from,
            `Qual seu pedido hoje, ${nome}? üòä\n\n*PIZZA üçï*\n*A√áA√ç üçß*`
        );

        aguardandoSenha[msg.from] = { etapa: 'aguardandoPedido', nome };
        return;
    }

    const dados = aguardandoSenha[msg.from];
    if (!dados || !dados.etapa) return;

    switch (dados.etapa) {
        case 'aguardandoPedido': {
            const pedido = msg.body.trim().toLowerCase();
            if (pedido.includes('pizza')) {
                await chat.sendStateTyping();
                await client.sendMessage(msg.from, `üçï Vamos montar sua pizza, ${dados.nome}!`);
                delete aguardandoSenha[msg.from];
            } else if (pedido.includes('a√ßa√≠') || pedido.includes('acai')) {
                await chat.sendStateTyping();
                await client.sendMessage(msg.from, `üçß Vamos montar seu a√ßa√≠, ${dados.nome}!`);
                await client.sendMessage(msg.from,
                    'Qual a√ßa√≠ voc√™ gosta mais?\n\n' +
                    'üçß *A√ßa√≠ Tradicional*\n' +
                    'üçì *A√ßa√≠ de Morango*\n' +
                    'üçå *A√ßa√≠ de Banana*'
                );
                dados.etapa = 'aguardandoSaborAcai';
                dados.comanda = {};
            } else {
                await chat.sendStateTyping();
                await client.sendMessage(msg.from, '‚ùå Op√ß√£o inv√°lida. Digite apenas *PIZZA* ou *A√áA√ç*.');
            }
            break;
        }
        case 'aguardandoSaborAcai': {
            const sabor = msg.body.trim();
            dados.comanda.saborAcai = sabor;
            dados.etapa = 'aguardandoAdicionais';
            await chat.sendStateTyping();
            await client.sendMessage(msg.from,
                'Agora vamos para os adicionais?\n\n' +
                '‚úÖ Voc√™ pode escolher at√© *3 adicionais* que s√£o de cortesia.\n' +
                '‚ö†Ô∏è Caso prefira mais adicionais, √© cobrado apenas *R$1,50 por adicional extra*.'
            );
            await client.sendMessage(msg.from,
                'Digite os adicionais separados por v√≠rgula:\n\n' +
                '‚Ä¢ Leite em P√≥\n' +
                '‚Ä¢ MMs\n' +
                '‚Ä¢ Calda de Morango\n' +
                '‚Ä¢ Calda de Chocolate\n' +
                '‚Ä¢ Granola\n' +
                '‚Ä¢ Leite Condensado\n' +
                '‚Ä¢ Granulado Colorido\n' +
                '‚Ä¢ Granulado de Chocolate\n' +
                '‚Ä¢ Coco Ralado'
            );            
            break;
        }
        case 'aguardandoAdicionais': {
            const adicionais = msg.body.split(',').map(a => a.trim()).filter(a => a);
            dados.comanda.adicionaisSelecionados = adicionais;
        
            if (adicionais.length > 3) {
                const extras = adicionais.slice(3);
                const custo = extras.length * 1.5;
        
                await chat.sendStateTyping();
                await client.sendMessage(msg.from,
                    `‚ö†Ô∏è Voc√™ escolheu mais de 3 adicionais.\n` +
                    `Ser√° cobrado *R$1,50* por adicional extra.\n\n` +
                    `üí∞ Total de adicionais pagos: *${extras.length} x R$1,50 = R$ ${custo.toFixed(2)}*\n\n` +
                    `Deseja manter esses adicionais?\n*Responda: SIM ou N√ÉO*`
                );
        
                dados.etapa = 'confirmarAdicionaisPagos';
            } else {
                dados.comanda.adicionais = adicionais;
                dados.comanda.valorExtras = 0;
                dados.etapa = 'perguntarOutroAcai';
        
                await chat.sendStateTyping();
                await client.sendMessage(msg.from, '‚ùì Deseja montar outro a√ßa√≠?\n*Responda: SIM ou N√ÉO*');
            }
            break;
        }
        
        case 'confirmarAdicionaisPagos': {
            const resposta = msg.body.trim().toLowerCase();
            const adicionais = dados.comanda.adicionaisSelecionados;
            if (resposta === 'sim') {
                const extras = adicionais.slice(3);
                const custo = extras.length * 1.5;
                dados.comanda.adicionais = adicionais;
                dados.comanda.valorExtras = custo;
            } else {
                dados.comanda.adicionais = adicionais.slice(0, 3);
                dados.comanda.valorExtras = 0;
            }
            dados.etapa = 'perguntarOutroAcai';
            await chat.sendStateTyping();
            await client.sendMessage(msg.from, '‚ùì Deseja montar outro a√ßa√≠?\n*Responda: SIM ou N√ÉO*');
            // if (!dados.comanda.listaAcais) dados.comanda.listaAcais = [];
            //     dados.comanda.listaAcais.push({
            //         sabor: dados.comanda.saborAcai,
            //         adicionais: dados.comanda.adicionais,
            //         valorExtras: dados.comanda.valorExtras
            //     });

            break;
        }
        
        case 'aguardandoLocalidade': {
            const localidade = msg.body.trim();
            dados.comanda.localidade = localidade;
            dados.comanda.valorFrete = precosFrete[localidade.toLowerCase()] || 0;
        
            await chat.sendStateTyping();
            await client.sendMessage(msg.from,
                'üìå Perfeito. Poderia me enviar a *localiza√ß√£o atual* e me informar o *endere√ßo direitinho* por favor?'
            );
        
            dados.etapa = 'aguardandoEndereco';
            break;
        }
        case 'aguardandoEndereco': {
            const endereco = msg.body.trim();
            dados.comanda.enderecoTexto = endereco;
        
            dados.etapa = 'formaPagamento';
            await chat.sendStateTyping();
            await client.sendMessage(msg.from,
                'üí≥ Como prefere pagar?\n\n1Ô∏è‚É£ Cart√£o (cr√©dito/d√©bito)\n2Ô∏è‚É£ Dinheiro (levar troco para quanto?)\n3Ô∏è‚É£ Pix'
            );            
            break;
        }        
        case 'perguntarOutroAcai': {
            const resposta = msg.body.trim().toLowerCase();
            if (!dados.comanda.listaAcais) dados.comanda.listaAcais = [];
        
            dados.comanda.listaAcais.push({
                sabor: dados.comanda.saborAcai,
                adicionais: dados.comanda.adicionais,
                valorExtras: dados.comanda.valorExtras
            });
        
            if (resposta === 'sim') {
                await chat.sendStateTyping();
                await client.sendMessage(msg.from,
                    'üçß Vamos montar mais um a√ßa√≠!\nQual sabor voc√™ deseja?\n- A√ßa√≠ Tradicional\n- A√ßa√≠ de Morango\n- A√ßa√≠ de Banana'
                );
                dados.etapa = 'aguardandoSaborAcai';
                delete dados.comanda.saborAcai;
                delete dados.comanda.adicionais;
                delete dados.comanda.valorExtras;
                delete dados.comanda.adicionaisSelecionados;
            } else {
                dados.etapa = 'aguardandoFrete';
                await chat.sendStateTyping();
                await client.sendMessage(msg.from,
                    'üöö Antes de finalizar, escolha sua *localidade* para calcularmos o frete:\n\n' +
                    'üìç *3 reais:* bom ser√°, licurizal, buraco d‚Äô√°gua\n' +
                    'üìç *5 reais:* lagoa velha, gazai, baixa da ema\n' +
                    'üìç *7 reais:* batista, ipoeira, pedra azul\n' +
                    'üìç *10 reais:* pindura saia, roma\n' +
                    'üìç *12 reais:* araticum\n' +
                    'üìç *15 reais:* quatro estradas, ponto, cabe√ßa do boi\n\n' +
                    '‚úèÔ∏è Digite o nome da sua localidade abaixo ‚¨áÔ∏è'
                );
            }
            break;
        }

        case 'aguardandoFrete': {
            const localidade = msg.body.trim();
            dados.comanda.localidade = localidade;
            dados.comanda.valorFrete = precosFrete[localidade.toLowerCase()] || 0;
        
            dados.etapa = 'aguardandoEndereco';
            await chat.sendStateTyping();
            await client.sendMessage(msg.from,
                'üìå Perfeito. Poderia me enviar a *localiza√ß√£o atual* e me informar o *endere√ßo direitinho* por favor?'
            );
            break;
        }

        case 'formaPagamento': {
            const forma = msg.body.trim().toLowerCase();
            if (forma.includes('cartao') || forma === '1' || forma.includes('cart√£o')) {
                dados.etapa = 'tipoCartao';
                await chat.sendStateTyping();
                await client.sendMessage(msg.from, 'üìå No cart√£o tem uma pequena taxa da maquininha, ok?');
                await delay(1000);
                await client.sendMessage(msg.from, 'Me confirma uma coisa. Vai ser no *Cr√©dito* ou *D√©bito*?');
            } else if (forma.includes('dinheiro') || forma === '2') {
                dados.etapa = 'trocoDinheiro';
                await client.sendMessage(msg.from, 'üíµ Certo! Precisa de troco pra quanto?');
            } else if (forma.includes('pix') || forma === '3') {
                dados.comanda.pagamento = 'Pix';
                await chat.sendStateTyping();
                await client.sendMessage(msg.from, 'üì≤ Chave Pix:\n*75974003081*\n*Iran Lima Silva*');
            
                dados.etapa = 'resumoFinal';
                client.emit('message', msg); // for√ßar envio do resumo
            } else {
                await client.sendMessage(msg.from, '‚ùå Op√ß√£o inv√°lida. Escolha:\n1Ô∏è‚É£ Cart√£o\n2Ô∏è‚É£ Dinheiro\n3Ô∏è‚É£ Pix');
            }
            break;
        }
        
        case 'tipoCartao': {
            const tipo = msg.body.trim().toLowerCase();
            const somaExtras = dados.comanda.listaAcais.reduce((acc, item) => acc + item.valorExtras, 0);
            const valorComFrete = somaExtras + dados.comanda.valorFrete;
        
            if (tipo.includes('d√©bito') || tipo.includes('debito')) {
                const taxa = valorComFrete * (TAXA_DEBITO / 100);
                dados.comanda.pagamento = 'Cart√£o (D√©bito)';
                dados.comanda.taxaCartao = taxa;
            } else if (tipo.includes('cr√©dito') || tipo.includes('credito')) {
                const taxa = valorComFrete * (TAXA_CREDITO / 100);
                dados.comanda.pagamento = 'Cart√£o (Cr√©dito)';
                dados.comanda.taxaCartao = taxa;
            } else {
                await client.sendMessage(msg.from, '‚ùå Por favor, diga se √© *Cr√©dito* ou *D√©bito*.');
                return;
            }
        
            dados.etapa = 'resumoFinal';
            client.emit('message', msg);
            break;
        }
        
        case 'trocoDinheiro': {
            const valor = msg.body.trim();
            dados.comanda.pagamento = `Dinheiro - Troco para R$ ${valor}`;
            dados.etapa = 'resumoFinal';
            client.emit('message', msg);
            break;
        }
        
        case 'resumoFinal': {
            const now = new Date();
            const dia = now.toLocaleDateString('pt-BR');
            const hora = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
            let resumo = `‚≠ê *RESUMO DE PEDIDO* ‚≠ê\n\n`;
            resumo += `*Nome:* ${dados.nome}\n\n`;
            resumo += `*Pedido:*\n`;
        
            let totalExtras = 0;
            dados.comanda.listaAcais.forEach((item, i) => {
                resumo += `${i + 1}. A√áA√ç - ${item.sabor}\n   ‚ûï Adicionais: ${item.adicionais.join(', ')}\n`;
                totalExtras += item.valorExtras;
                if (item.valorExtras > 0) {
                    resumo += `   üí∞ Adicionais pagos: R$ ${item.valorExtras.toFixed(2)}\n`;
                }
            });
        
            const frete = dados.comanda.valorFrete || 0;
            const taxa = dados.comanda.taxaCartao || 0;
            const valorAcais = dados.comanda.listaAcais.length * VALOR_ACAI;
            const total = valorAcais + totalExtras + frete + taxa;
        
            resumo += `${dados.comanda.listaAcais.length + 1}. FRETE R$ ${frete.toFixed(2)}\n`;
            resumo += `---------------------------\n\n`;
        
            resumo += `*Valor Total a pagar:* R$ ${total.toFixed(2)}\n`;
            resumo += `====================\n\n`;
        
            resumo += `üõµ *Com Entrega*\n`;
            resumo += `===== *Endere√ßo* =====\n`;
            resumo += `${dados.comanda.localidade}, ${dados.comanda.enderecoTexto}\n`;
            resumo += `====================\n\n`;
        
            resumo += `üí≥ *Forma de Pagamento:* ${dados.comanda.pagamento || 'N√£o informado'}\n`;
            if (dados.comanda.pagamento?.toLowerCase().includes('troco')) {
                const match = dados.comanda.pagamento.match(/R\$\s?\d+(?:,\d{2})?/);
                if (match) resumo += `üí≤ *Levar Troco Pra:* ${match[0]}\n`;
            }
        
            resumo += `\n---------------------------\n`;
            resumo += `*Pedido realizado em:*\n${dia} | ${hora}\n\n`;
            resumo += `üòä *Agradecemos a Prefer√™ncia!!*`;
        
            await chat.sendStateTyping();
            await client.sendMessage(msg.from, resumo);
            delete aguardandoSenha[msg.from];
            break;
        }
        
        
        
    }
});
